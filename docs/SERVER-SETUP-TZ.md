# Техническое задание на настройку сервера для GroupBuy Bot

## 1. Общая информация

| Параметр | Значение |
|----------|----------|
| **Название проекта** | GroupBuy Bot - Сервис совместных закупок |
| **Дата составления** | Февраль 2026 |
| **Версия документа** | 1.0 |
| **Тип развёртывания** | Docker-контейнеры |

## 2. Назначение системы

Система представляет собой мультиплатформенный бот для организации совместных закупок с поддержкой:
- Telegram бота
- WebSocket чата в реальном времени
- React веб-интерфейса
- Интеграции с платёжной системой YooKassa

## 3. Требования к серверу

### 3.1 Вариант A: Один сервер (небольшая нагрузка)

#### Аппаратные требования

| Компонент | Минимум | Рекомендуется |
|-----------|---------|---------------|
| **CPU** | 2 ядра | 4 ядра |
| **RAM** | 4 ГБ | 8 ГБ |
| **Диск** | 20 ГБ SSD | 50 ГБ SSD |
| **Сеть** | 100 Мбит/с | 1 Гбит/с |

#### Сетевые требования

| Порт | Протокол | Назначение |
|------|----------|------------|
| 22 | TCP | SSH доступ |
| 80 | TCP | HTTP (перенаправление на HTTPS) |
| 443 | TCP | HTTPS |
| 8765 | TCP | WebSocket (если без nginx) |

### 3.2 Вариант B: Два сервера (высокая нагрузка)

#### Сервер 1 — Чат-сервер

| Компонент | Минимум | Рекомендуется |
|-----------|---------|---------------|
| **CPU** | 2 ядра | 4 ядра |
| **RAM** | 2 ГБ | 4 ГБ |
| **Диск** | 10 ГБ SSD | 20 ГБ SSD |
| **Сеть** | 100 Мбит/с | 1 Гбит/с |

**Сервисы на Сервере 1:**
- WebSocket сервер
- Redis (кэш чата)
- Nginx (SSL/proxy)

#### Сервер 2 — API-сервер

| Компонент | Минимум | Рекомендуется |
|-----------|---------|---------------|
| **CPU** | 2 ядра | 4 ядра |
| **RAM** | 4 ГБ | 8 ГБ |
| **Диск** | 30 ГБ SSD | 100 ГБ SSD |
| **Сеть** | 100 Мбит/с | 1 Гбит/с |

**Сервисы на Сервере 2:**
- Rust API (core)
- Telegram Bot
- Telegram Adapter
- PostgreSQL
- Redis (API кэш)
- React Frontend
- Nginx (SSL/proxy)

## 4. Требования к программному обеспечению

### 4.1 Операционная система

| Параметр | Требование |
|----------|------------|
| **ОС** | Ubuntu 22.04 LTS / Ubuntu 24.04 LTS / Debian 12 |
| **Архитектура** | x86_64 (amd64) |
| **Ядро Linux** | 5.15+ |

### 4.2 Обязательное ПО

| Компонент | Версия | Назначение |
|-----------|--------|------------|
| **Docker** | 24.0+ | Контейнеризация |
| **Docker Compose** | 2.20+ | Оркестрация контейнеров |
| **Git** | 2.30+ | Управление кодом |
| **curl** | любая | Тестирование API |

### 4.3 Рекомендуемое ПО

| Компонент | Версия | Назначение |
|-----------|--------|------------|
| **htop** | любая | Мониторинг ресурсов |
| **certbot** | 2.0+ | SSL сертификаты |
| **ufw** | любая | Файрвол |
| **fail2ban** | любая | Защита от brute-force |

## 5. Конфигурация DNS

### 5.1 Для одного сервера

| Запись | Тип | Значение |
|--------|-----|----------|
| `your-domain.com` | A | IP_СЕРВЕРА |
| `api.your-domain.com` | A | IP_СЕРВЕРА |
| `chat.your-domain.com` | A | IP_СЕРВЕРА |

### 5.2 Для двух серверов

| Запись | Тип | Значение |
|--------|-----|----------|
| `api.your-domain.com` | A | IP_СЕРВЕРА_2 |
| `chat.your-domain.com` | A | IP_СЕРВЕРА_1 |
| `your-domain.com` | A | IP_СЕРВЕРА_2 |

## 6. Переменные окружения

### 6.1 Обязательные переменные

| Переменная | Описание | Пример |
|------------|----------|--------|
| `DB_NAME` | Имя базы данных | `groupbuy` |
| `DB_USER` | Пользователь БД | `postgres` |
| `DB_PASSWORD` | Пароль БД | `<сгенерировать>` |
| `TELEGRAM_TOKEN` | Токен бота Telegram | `123456:ABC-DEF...` |
| `JWT_SECRET` | Секрет для JWT токенов | `<сгенерировать 32+ символа>` |

### 6.2 Платёжная система (YooKassa)

| Переменная | Описание | Где получить |
|------------|----------|--------------|
| `YOOKASSA_SHOP_ID` | ID магазина | Личный кабинет YooKassa |
| `YOOKASSA_SECRET_KEY` | Секретный ключ | Личный кабинет YooKassa |

### 6.3 Дополнительные переменные

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `ALLOWED_HOSTS` | Разрешённые домены | `localhost,127.0.0.1` |
| `RUST_LOG` | Уровень логов Rust | `info,groupbuy_api=debug` |
| `LOG_LEVEL` | Уровень логов Python | `INFO` |
| `CORE_API_URL` | URL API (для двух серверов) | `http://core:8000/api` |

### 6.4 Генерация безопасных значений

```bash
# Генерация пароля БД (32 символа)
openssl rand -base64 32

# Генерация JWT секрета (64 символа)
openssl rand -hex 32

# Генерация Django SECRET_KEY
python3 -c "import secrets; print(secrets.token_urlsafe(50))"
```

## 7. SSL сертификаты

### 7.1 Требования

| Параметр | Значение |
|----------|----------|
| **Тип сертификата** | Let's Encrypt (бесплатный) или коммерческий |
| **Алгоритм** | RSA 2048+ или ECDSA |
| **Срок действия** | 90 дней (Let's Encrypt) |
| **Автообновление** | Обязательно |

### 7.2 Файлы сертификатов

| Файл | Путь | Описание |
|------|------|----------|
| Сертификат | `/etc/nginx/ssl/fullchain.pem` | Полная цепочка сертификатов |
| Приватный ключ | `/etc/nginx/ssl/privkey.pem` | Приватный ключ (chmod 600) |

## 8. Сетевая безопасность

### 8.1 Настройка файрвола (UFW)

```bash
# Базовые правила
sudo ufw default deny incoming
sudo ufw default allow outgoing

# SSH (изменить порт при необходимости)
sudo ufw allow 22/tcp

# HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Включить файрвол
sudo ufw enable
```

### 8.2 Рекомендации по безопасности

| Рекомендация | Приоритет |
|--------------|-----------|
| Отключить вход по паролю SSH (только ключи) | Высокий |
| Изменить стандартный порт SSH | Средний |
| Настроить fail2ban | Высокий |
| Ограничить доступ к портам PostgreSQL и Redis | Высокий |
| Регулярно обновлять систему | Высокий |

## 9. Резервное копирование

### 9.1 Что необходимо бэкапить

| Данные | Частота | Хранение |
|--------|---------|----------|
| База данных PostgreSQL | Ежедневно | 30 дней |
| Загруженные файлы (media) | Еженедельно | 90 дней |
| Конфигурация (.env) | При изменении | Бессрочно |
| SSL сертификаты | При обновлении | Бессрочно |

### 9.2 Скрипт резервного копирования

```bash
#!/bin/bash
# backup.sh - разместить в /opt/groupbuy/scripts/

BACKUP_DIR="/backups/groupbuy"
DATE=$(date +%Y%m%d_%H%M%S)

# Создать директорию
mkdir -p $BACKUP_DIR

# Бэкап PostgreSQL
docker exec groupbuy-postgres pg_dump -U postgres groupbuy | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# Бэкап .env файла
cp /opt/groupbuy/.env $BACKUP_DIR/env_$DATE.bak

# Удалить бэкапы старше 30 дней
find $BACKUP_DIR -name "*.gz" -mtime +30 -delete
find $BACKUP_DIR -name "*.bak" -mtime +30 -delete

echo "Backup completed: $DATE"
```

### 9.3 Cron задание

```bash
# Добавить в crontab -e
0 3 * * * /opt/groupbuy/scripts/backup.sh >> /var/log/groupbuy-backup.log 2>&1
```

## 10. Мониторинг

### 10.1 Проверка здоровья сервисов

| Сервис | Эндпоинт | Ожидаемый ответ |
|--------|----------|-----------------|
| Nginx | `http://localhost/health` | `200 OK` |
| API | `http://localhost:8000/api/users/` | `200 OK` |
| WebSocket | `ws://localhost:8765/health` | Подключение успешно |
| PostgreSQL | `pg_isready -h localhost` | Готов к подключению |
| Redis | `redis-cli ping` | `PONG` |

### 10.2 Логи

| Сервис | Команда просмотра |
|--------|-------------------|
| Все сервисы | `docker-compose logs -f` |
| Core API | `docker-compose logs -f core` |
| Bot | `docker-compose logs -f bot` |
| PostgreSQL | `docker-compose logs -f postgres` |
| Nginx | `docker-compose logs -f nginx` |

### 10.3 Метрики (рекомендуется)

| Метрика | Инструмент |
|---------|------------|
| CPU/RAM/Диск | `htop`, `df -h` |
| Docker контейнеры | `docker stats` |
| Сетевая активность | `nethogs`, `iftop` |

## 11. Процедура обновления

### 11.1 Стандартное обновление

```bash
cd /opt/groupbuy

# 1. Создать бэкап
./scripts/backup.sh

# 2. Получить обновления
git pull origin main

# 3. Пересобрать образы
docker-compose build

# 4. Перезапустить сервисы
docker-compose up -d

# 5. Проверить логи
docker-compose logs -f --tail=50
```

### 11.2 Откат при проблемах

```bash
# Откат к предыдущему коммиту
git checkout HEAD~1

# Пересборка и перезапуск
docker-compose build
docker-compose up -d

# Восстановление БД из бэкапа (при необходимости)
gunzip -c /backups/groupbuy/db_YYYYMMDD.sql.gz | docker exec -i groupbuy-postgres psql -U postgres groupbuy
```

## 12. Контакты для поддержки

| Тип вопроса | Контакт |
|-------------|---------|
| Технические проблемы | GitHub Issues |
| Критические инциденты | [указать контакт] |

## 13. Чек-лист настройки сервера

### 13.1 Подготовка сервера

- [ ] Сервер соответствует минимальным требованиям
- [ ] Установлена Ubuntu 22.04 LTS / Debian 12
- [ ] Настроен SSH доступ (только по ключам)
- [ ] Настроен файрвол (UFW)
- [ ] Установлен Docker и Docker Compose
- [ ] Установлен Git
- [ ] Создан пользователь для приложения (не root)

### 13.2 Настройка DNS

- [ ] Создана A-запись для домена
- [ ] DNS записи распространились (проверить через `dig`)

### 13.3 Развёртывание приложения

- [ ] Склонирован репозиторий
- [ ] Создан и заполнен файл `.env`
- [ ] Запущены контейнеры
- [ ] Проверена работоспособность API
- [ ] Проверена работа Telegram бота
- [ ] Проверен WebSocket чат

### 13.4 Безопасность

- [ ] Настроены SSL сертификаты (Let's Encrypt)
- [ ] Включено перенаправление HTTP → HTTPS
- [ ] Настроен fail2ban
- [ ] Пароли и секреты надёжно сгенерированы
- [ ] Порты PostgreSQL и Redis закрыты снаружи

### 13.5 Обслуживание

- [ ] Настроено автоматическое резервное копирование
- [ ] Настроено автообновление SSL сертификатов
- [ ] Документированы все настройки
- [ ] Проведено тестовое восстановление из бэкапа

---

## Приложение A: Структура директорий на сервере

```
/opt/groupbuy/
├── .env                      # Переменные окружения (chmod 600)
├── docker-compose.yml        # Конфигурация Docker
├── docker-compose.prod.yml   # Продакшен конфигурация
├── bot/                      # Telegram бот
├── core/                     # Django backend (если используется)
├── core-rust/                # Rust backend
├── frontend-react/           # React фронтенд
├── infrastructure/
│   ├── nginx/
│   │   ├── nginx.conf
│   │   └── ssl/
│   │       ├── fullchain.pem
│   │       └── privkey.pem
│   └── websocket/
├── scripts/
│   └── backup.sh
└── logs/

/backups/groupbuy/            # Резервные копии
├── db_YYYYMMDD_HHMMSS.sql.gz
└── env_YYYYMMDD_HHMMSS.bak

/var/log/
├── groupbuy-backup.log       # Логи резервного копирования
└── nginx/                    # Логи Nginx
```

## Приложение B: Полезные команды

```bash
# Статус всех контейнеров
docker-compose ps

# Использование ресурсов
docker stats

# Подключение к БД
docker exec -it groupbuy-postgres psql -U postgres groupbuy

# Подключение к Redis
docker exec -it groupbuy-redis redis-cli

# Перезапуск отдельного сервиса
docker-compose restart core

# Полная пересборка
docker-compose down && docker-compose build --no-cache && docker-compose up -d

# Очистка Docker (осторожно!)
docker system prune -f
docker volume prune -f  # Удалит данные!

# Проверка SSL сертификата
echo | openssl s_client -connect your-domain.com:443 2>/dev/null | openssl x509 -noout -dates

# Тест API
curl -s http://localhost:8000/api/users/ | jq
```
